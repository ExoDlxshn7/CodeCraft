@using System.Security.Claims
@model IEnumerable<SubApp1.Models.Post>

@{
    ViewData["Title"] = "Home Page";
}

<script src="https://kit.fontawesome.com/b090154bf0.js" crossorigin="anonymous"></script>

<body>
    <div id="profile-container-left">
    </div>
    <div id="profile-container-right">
        <div id="container-post">
        </div>

       @foreach (var post in Model)
        {
            <div id="container-post">
                <div id="post-header">
                    <div id="post-pp">
                        <img alt="Profile picture" id="pp-content"src="@(post.Users?.ProfilePic ?? "/Images/default-profile.jpg")" / >
                    </div>
                    <div id="post-profile">
                        @if (post.Users != null)
                        {
                            @post.Users.UserName
                        }
                        else
                        {
                            <span>Unknown User</span>
                        }   
                    </div>
                    <div id="post-posted">
                        <span>@post.CreatedAt.ToString("MMM dd") <br>at @post.CreatedAt.ToString("HH:mm")</span>
                    </div>
                </div>
                
                <div id="post-contents">
                    <p>@post.Content</p>
                    
                    @if (!string.IsNullOrEmpty(post.ImageUrl))
                    {
                        <img id="photo" src="@post.ImageUrl" />
                    }
                    

                    <div id="post-interaction">
                        <span>
                           @if (User.Identity.IsAuthenticated)
                            {
                                <form asp-action="AddCommentIndex" asp-controller="Comment" method="post">
                                    <input type="hidden" name="postId" value="@post.Id" />
                                    <textarea name="comments" placeholder="Write a comment..." required></textarea>
                                    <button type="submit">Add Comment</button>
                                </form>
                            }
                            else
                            {
                                <p>You must be logged in to write a comment.</p>
                                <p><a class="nav-link text-light" id="login" asp-area="Identity" asp-page="/Account/Login">Login</a></p>
                            }
                        </span>
                    </div>
                    <div id="comments-section">
                        <h4>Comments</h4>
                        @if (post.Comments != null && post.Comments.Any())
                        {
                        <ul>
                             @foreach (var comment in post.Comments)
                            {
                                <li>
                                    <strong>@comment?.Users?.UserName:</strong> @comment.Comments
                                    <span>@comment.CreatedAt.ToString("MMM dd, HH:mm")</span>

                                    @if (comment.UserId == User.FindFirstValue(ClaimTypes.NameIdentifier))
                                    {
                                        <button type="button" onclick="showEditForm(@comment.Id)">Edit</button>

                                        <!-- The edit form (hidden initially) -->
                                        <form id="edit-form-@comment.Id" style="display:none;" asp-action="EditCommentIndex" asp-controller="Comment" method="post">
                                            <input type="hidden" name="commentId" value="@comment.Id" />
                                            <textarea name="comments" placeholder="Edit your comment..." required>@comment.Comments</textarea>
                                            <button type="submit">Save Changes</button>
                                        </form>
                                    }

                                    @if (comment.UserId == User.FindFirstValue(ClaimTypes.NameIdentifier) || post.UserId == User.FindFirstValue(ClaimTypes.NameIdentifier))
                                    {
                                        <form asp-action="DeleteCommentIndex" asp-controller="Comment" method="post" style="display:inline;">
                                            <input type="hidden" name="commentId" value="@comment.Id" />
                                            <button type="submit" onclick="return confirm('Are you sure you want to delete this comment?');">Delete</button>
                                        </form>
                                    }
                                </li>
                            }   
                        </ul>
                        }
                        else
                        {
                            <p>No comments yet.</p>
                        }
                    </div>
                    <script>
                    // Function to show the edit form when the "Edit" button is clicked
                        function showEditForm(commentId) {
                            var form = document.getElementById('edit-form-' + commentId);
                            form.style.display = 'block'; // Show the form
                        }
                    </script>
                </div>
            </div>
        }
    </div>
</body>
